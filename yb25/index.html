<!DOCTYPE html>
<html>

<head>
	<script src="https://aframe.io/releases/0.6.0/aframe.min.js"></script>
	<script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.5.0/aframe/build/aframe-ar.js"></script>
	<script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v3.8.4/dist/aframe-extras.min.js"></script>
	<script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script> <!-- QR code scanning library -->

	<script>
		// QR code reader with debounce
		let debounceTimeout;

		function scanQRCode(videoElement, callback) {
			const canvasElement = document.createElement('canvas');
			const canvas = canvasElement.getContext("2d");
			const video = videoElement;

			video.play();

			function tick() {
				if (video.readyState === video.HAVE_ENOUGH_DATA) {
					canvasElement.height = video.videoHeight;
					canvasElement.width = video.videoWidth;
					canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
					const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
					const code = jsQR(imageData.data, imageData.width, imageData.height, {
						inversionAttempts: "dontInvert",
					});

					if (code) {
						if (!debounceTimeout) {
							// Debounce the QR code detection by waiting 1 second before processing the next one
							debounceTimeout = setTimeout(() => {
								debounceTimeout = null;
							}, 1000);

							callback(code.data); // QR code data found
						}
					}
				}
				requestAnimationFrame(tick);
			}
			tick();
		}

		// Custom component to handle video play and QR code scanning
		AFRAME.registerComponent('vidhandler', {
			init: function () {
				this.toggle = false;
				this.vid = document.querySelector("#vid");
				this.videoID = null; // Placeholder for the video ID from the QR code

				// Access the webcam to scan for QR codes
				const webcamVideo = document.createElement('video');
				navigator.mediaDevices.getUserMedia({
					video: {
						facingMode: "environment"
					}
				}).then((stream) => {
					webcamVideo.srcObject = stream;
					scanQRCode(webcamVideo, (qrData) => {
						const videoID = qrData.match(/[A-Z0-9]{4}/); // Assuming a 4-character ID in the QR code
						if (videoID && this.videoID !== videoID[0]) {
							this.loadNewVideo(videoID[0]);
						}
					});
				});
			},

			// Load new video, ensuring the source is reset correctly
			loadNewVideo: function (videoID) {
				this.vid.pause();        // Pause the current video
				this.vid.removeAttribute('src');  // Remove the source
				this.vid.load();         // Force the video element to reset and reload

				this.videoID = videoID;  // Set the new video ID
				const videoURL = `./${videoID}.mp4`;
				console.log("New video source:", videoURL);

				this.vid.src = videoURL;  // Set the new video source

				// Listen for the 'loadeddata' event to ensure the video is fully ready before playing
				this.vid.onloadeddata = () => {
					console.log("Video loaded, playing...");
					this.toggle = true;
					this.vid.play().catch(err => {
						console.error("Error playing video:", err);
						this.toggle = false;  // Reset the toggle if playback fails
					});
				};

				// Handle errors with loading the video
				this.vid.onerror = (err) => {
					console.error("Error loading video:", err);
				};
			},

			tick: function () {
				// Only play video if the QR code has been scanned and marker is visible
				if (this.el.object3D.visible === true && this.toggle) {
					if (this.vid.paused) {
						console.log("Playing video...");
						this.vid.play();
					}
				} else {
					if (!this.vid.paused) {
						console.log("Pausing video...");
						this.vid.pause();
					}
				}
			}
		});
	</script>

</head>

<body style='margin : 0px; overflow: hidden;'>

	<div style="font-size: 64px; color: red; position: fixed; left: 0;">
		DEVELOPMENT
	</div>

	<a-scene embedded artoolkit='sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; maxDetectionRate: 30; canvasWidth: 240; canvasHeight: 180;'>
		<a-assets>
			<video id="vid" loop="true" crossorigin="anonymous"></video> <!-- Video source will be set dynamically -->
		</a-assets>

		<a-marker id="memarker" preset="kanji" vidhandler>
			<a-plane position='1 2 -2' scale="2 2 2" width="2" rotation="-90 0 0" material='transparent:true;opacity: 1;src:#vid'></a-plane>
		</a-marker>

	</a-scene>
</body>

</html>
